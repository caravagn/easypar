<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LSF array jobs with easypar â€¢ easypar</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="LSF array jobs with easypar">
<meta property="og:description" content="">
<meta property="og:image" content="/logo.png">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">easypar</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.2.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/easypar.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/lsf.html">LSF array jobs with easypar</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/caravagn/easypar">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>LSF array jobs with easypar</h1>
                        <h4 class="author">Giulio Caravagna</h4>
            
            <h4 class="date">15 September 2019</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/caravagn/easypar/blob/master/vignettes/lsf.Rmd"><code>vignettes/lsf.Rmd</code></a></small>
      <div class="hidden name"><code>lsf.Rmd</code></div>

    </div>

    
    
<p><code>easypar</code> can be used to generate scripts that submit array jobs to the LSF cluster system.</p>
<p>First, write in R your code.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="co"># Computation function </span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2">FUN =<span class="st"> </span><span class="cf">function</span>(x, y){  ... }</a>
<a class="sourceLine" id="cb1-3" data-line-number="3"></a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="co"># Input for 25 array jobs that match FUN arguments</span></a>
<a class="sourceLine" id="cb1-5" data-line-number="5">PARAMS =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="dt">x =</span> <span class="kw"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="dv">25</span>), <span class="dt">y =</span> <span class="kw"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="dv">25</span>))</a>
<a class="sourceLine" id="cb1-6" data-line-number="6"></a>
<a class="sourceLine" id="cb1-7" data-line-number="7"><span class="co"># Generates submission files </span></a>
<a class="sourceLine" id="cb1-8" data-line-number="8"><span class="kw"><a href="../reference/run_lsf.html">run_lsf</a></span>(FUN, PARAMS)</a></code></pre></div>
<p>Then, in your terminal.</p>
<pre class="{"><code># Test if the generated script runs with the first input 
head -1 EASYPAR_LSF_input_jobarray.csv | Rscript EASYPAR_LSF_Run.R

# Submit array jobs (after loading the cluster module)
bsub &lt; EASYPAR_LSF_submission.sh</code></pre>
<div id="requirements" class="section level4">
<h4 class="hasAnchor">
<a href="#requirements" class="anchor"></a>Requirements</h4>
<!-- To use  `run_lsf` you need: -->
<ul>
<li>a function <code>FUN</code> (e.g.,: <code>FUN = ls</code>) that can run as a stand-alone R application, with its own parameters and that manages explicitly its dependencies.</li>
</ul>
<blockquote>
<p>Note: <code>FUN</code> will be run as an indipendent process.</p>
</blockquote>
<ul>
<li>a dataframe <code>PARAMS</code> where every row is an input for <code>FUN</code>. The column order must match <code>FUN</code> arguments.</li>
</ul>
<p>Conceptually, you set up the data as for an <code><a href="https://rdrr.io/r/base/apply.html">apply(FUN, MARGIN = 1)</a></code> by row.</p>
<p>The input should have column names without dots or spaces; these will match the arguments of <code>FUN</code>. So, for instance, an input with 2-columns will only work if <code>FUN</code> has 2 parameters.</p>
</div>
<div id="output" class="section level4">
<h4 class="hasAnchor">
<a href="#output" class="anchor"></a>Output</h4>
<p><code>run_lsf</code> generates 3 files:</p>
<ul>
<li><p>an R script wrapping the definition of <code>FUN</code>, with extra code to call <code>FUN</code> using parameters from the command line. Your function in this script is called with a fake name;</p></li>
<li><p>a <code>csv</code> file containing the input <code>PARAMS</code>, without any header (column names), and row names.</p></li>
<li><p>a LSF array job submission script with <code>N</code> jobs where <code>N</code> are the rows of <code>PARAMS</code>.</p></li>
</ul>
<p>Before submitting the job, test the computation as explained above.</p>
</div>
<div id="customising-jobs" class="section level4">
<h4 class="hasAnchor">
<a href="#customising-jobs" class="anchor"></a>Customising jobs</h4>
<p>Cluster-specific BSUB instructions can be specified, as well as other dependencies from modules available on the cluster.</p>
<p>Function <code>run_lsf</code> allows to:</p>
<ul>
<li><p>specify a list of modules that will be added as dependencies of the LSF submission script. For instance, <code>modules = 'R/3.5.0'</code> will generate the dependecy for a specific R version (<code>3.5.0</code>).</p></li>
<li><p>customize the BSUB parameters of the generated script.</p></li>
</ul>
<p>The package comes with a default BSUB configuration, that <strong>has to be updated according to your cluster setup</strong>.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(easypar)</a>
<a class="sourceLine" id="cb3-2" data-line-number="2"></a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="co"># Default parameters in the package</span></a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="kw"><a href="../reference/default_BSUB_config.html">default_BSUB_config</a></span>()</a></code></pre></div>
<pre><code>## $`-J`
## [1] "EASYPAR_Runner"
## 
## $`-P`
## [1] "dummy_project"
## 
## $`-q`
## [1] "short"
## 
## $`-n`
## [1] 1
## 
## $`-R`
## [1] "\"span[hosts=1]\""
## 
## $`-W`
## [1] "4:00"
## 
## $`-o`
## [1] "log/output.%J.%I"
## 
## $`-e`
## [1] "log/errors.%J.%I"</code></pre>
<p>These are classical BSUB parameters:</p>
<ul>
<li>
<code>-J</code>, the job ID;</li>
<li>
<code>-P</code>, the project ID;</li>
<li>
<code>-q</code>, the queue ID;</li>
<li>
<code>-n</code> and <code>-R</code>, the resources to allocate;</li>
<li>
<code>-W</code> the wall time of the jobs;</li>
<li>
<code>-o</code> and <code>-e</code>, the outputs and the error filenames. Notice that by default we have the job array ID in the filename, so to have one log per job.</li>
</ul>
<blockquote>
<p>It is required to modify the default values of <code>-P</code> and <code>-q</code>, the project and queue ID, according to your LSF configuration. Otherwise, the submission script will generate an error becaue the default values do not mean anything.</p>
</blockquote>
<p>Modifications are done to the default list of parameters; other BSUB flags can be used as well. No checkings on their correctness are done by <code>easypar</code>.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1">custom_BSUB =<span class="st"> </span><span class="kw"><a href="../reference/default_BSUB_config.html">default_BSUB_config</a></span>()</a>
<a class="sourceLine" id="cb5-2" data-line-number="2"></a>
<a class="sourceLine" id="cb5-3" data-line-number="3"><span class="co"># More informative job ID</span></a>
<a class="sourceLine" id="cb5-4" data-line-number="4">custom_BSUB<span class="op">$</span><span class="st">`</span><span class="dt">-J</span><span class="st">`</span> =<span class="st"> "bwa_aligner"</span></a>
<a class="sourceLine" id="cb5-5" data-line-number="5"></a>
<a class="sourceLine" id="cb5-6" data-line-number="6"><span class="co"># A token for a project allowed to run on the cluster</span></a>
<a class="sourceLine" id="cb5-7" data-line-number="7">custom_BSUB<span class="op">$</span><span class="st">`</span><span class="dt">-P</span><span class="st">`</span> =<span class="st"> "DKSMWOP331"</span></a>
<a class="sourceLine" id="cb5-8" data-line-number="8"></a>
<a class="sourceLine" id="cb5-9" data-line-number="9"><span class="co"># A queue name that is valid on the cluster</span></a>
<a class="sourceLine" id="cb5-10" data-line-number="10">custom_BSUB<span class="op">$</span><span class="st">`</span><span class="dt">-q</span><span class="st">`</span> =<span class="st"> "bioinformatics"</span></a>
<a class="sourceLine" id="cb5-11" data-line-number="11"></a>
<a class="sourceLine" id="cb5-12" data-line-number="12"><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(custom_BSUB)</a></code></pre></div>
<pre><code>## $`-J`
## [1] "bwa_aligner"
## 
## $`-P`
## [1] "DKSMWOP331"
## 
## $`-q`
## [1] "bioinformatics"
## 
## $`-n`
## [1] 1
## 
## $`-R`
## [1] "\"span[hosts=1]\""
## 
## $`-W`
## [1] "4:00"
## 
## $`-o`
## [1] "log/output.%J.%I"
## 
## $`-e`
## [1] "log/errors.%J.%I"</code></pre>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="co"># Shorter version</span></a>
<a class="sourceLine" id="cb7-2" data-line-number="2">custom_BSUB =<span class="st"> </span><span class="kw"><a href="../reference/default_BSUB_config.html">default_BSUB_config</a></span>(<span class="dt">J =</span> <span class="st">'bwa_aligner'</span>, <span class="dt">P =</span> <span class="st">'DKSMWOP331'</span>, <span class="dt">q =</span> <span class="st">'bioinformatics'</span>)</a>
<a class="sourceLine" id="cb7-3" data-line-number="3"></a>
<a class="sourceLine" id="cb7-4" data-line-number="4"><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(custom_BSUB)</a></code></pre></div>
<pre><code>## $`-J`
## [1] "bwa_aligner"
## 
## $`-P`
## [1] "DKSMWOP331"
## 
## $`-q`
## [1] "bioinformatics"
## 
## $`-n`
## [1] 1
## 
## $`-R`
## [1] "\"span[hosts=1]\""
## 
## $`-W`
## [1] "4:00"
## 
## $`-o`
## [1] "log/output.%J.%I"
## 
## $`-e`
## [1] "log/errors.%J.%I"</code></pre>
<p>Once the BSUB has been customized, you can either:</p>
<ul>
<li>generate the submission scripts, and submit your job manually</li>
<li>generate the submission scripts and submit the jobs with a <code>system</code> call.</li>
</ul>
<p>By default (<code>run = FALSE</code>) the <code>run_lsf</code> function outputs the shell command that should be used to submit the jobs, but leaves the user to submit the job. This is because we experienced some command line issues calling modules with a system call.</p>
</div>
<div id="example" class="section level4">
<h4 class="hasAnchor">
<a href="#example" class="anchor"></a>Example</h4>
<p>An example computation follows.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="co"># A simple function that prints some outputs</span></a>
<a class="sourceLine" id="cb9-2" data-line-number="2">FUN =<span class="st"> </span><span class="cf">function</span>(x, y){ </a>
<a class="sourceLine" id="cb9-3" data-line-number="3">  <span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(x, y) </a>
<a class="sourceLine" id="cb9-4" data-line-number="4">}</a>
<a class="sourceLine" id="cb9-5" data-line-number="5"></a>
<a class="sourceLine" id="cb9-6" data-line-number="6"><span class="co"># input for 25 array jobs</span></a>
<a class="sourceLine" id="cb9-7" data-line-number="7">PARAMS =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(</a>
<a class="sourceLine" id="cb9-8" data-line-number="8">  <span class="dt">x =</span> <span class="kw"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="dv">25</span>), </a>
<a class="sourceLine" id="cb9-9" data-line-number="9">  <span class="dt">y =</span> <span class="kw"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="dv">25</span>)</a>
<a class="sourceLine" id="cb9-10" data-line-number="10">  )</a>
<a class="sourceLine" id="cb9-11" data-line-number="11"></a>
<a class="sourceLine" id="cb9-12" data-line-number="12"><span class="co"># generates the input files, adding some module dependencies</span></a>
<a class="sourceLine" id="cb9-13" data-line-number="13"><span class="kw"><a href="../reference/run_lsf.html">run_lsf</a></span>(FUN, </a>
<a class="sourceLine" id="cb9-14" data-line-number="14">        PARAMS, </a>
<a class="sourceLine" id="cb9-15" data-line-number="15">        <span class="dt">BSUB_config =</span> custom_BSUB,</a>
<a class="sourceLine" id="cb9-16" data-line-number="16">        <span class="dt">modules =</span> <span class="st">'R/3.5.0'</span></a>
<a class="sourceLine" id="cb9-17" data-line-number="17">        )</a></code></pre></div>
<pre><code>## Destination folder for the LSF scripts and inputs:  . 
## Creating folder for output and error logs:  log</code></pre>
<pre><code>## Warning in dir.create(folder[1]): 'log' already exists</code></pre>
<pre><code>## [easypar]: generated LSF submission script</code></pre>
<pre><code>## #!/bin/bash
## 
## #BSUB -J bwa_aligner[1-25]
## #BSUB -P DKSMWOP331
## #BSUB -q bioinformatics
## #BSUB -n 1
## #BSUB -R "span[hosts=1]"
## #BSUB -W 4:00
## #BSUB -o log/output.%J.%I
## #BSUB -e log/errors.%J.%I
## 
## # =-=-=-=-=-=-=-=-=-=-=-=-=-==-=-=-=-=-=-=-=-=
## # Automatic LSF script generated via easypar
## # 2019-11-02 15:15:53
## # =-=-=-=-=-=-=-=-=-=-=-=-=-==-=-=-=-=-=-=-=-=
## 
## # Required modules
## module load R/3.5.0 
## 
## 
## # Input file and R script
## file_input=EASYPAR_LSF_input_jobarray.csv
## R_script=EASYPAR_LSF_Run.R
## line=$LSB_JOBINDEX
## 
## # Data loading
## x=$( awk -v line=$line 'BEGIN {FS="\t"}; FNR==line {print $1}' $file_input)
## y=$( awk -v line=$line 'BEGIN {FS="\t"}; FNR==line {print $2}' $file_input)
## 
## # Job run
## Rscript $R_script $x $y</code></pre>
<pre><code>## [easypar]: generated input file from input data.frame</code></pre>
<pre><code>## [easypar]: generated R script from input function</code></pre>
<pre><code>## 
## Scripts generated, submit your job with the following shell command.</code></pre>
<pre><code>## bsub &lt; EASYPAR_LSF_submission.sh</code></pre>
</div>
<div id="submitting-the-job" class="section level4">
<h4 class="hasAnchor">
<a href="#submitting-the-job" class="anchor"></a>Submitting the job</h4>
<p>If you do not try to run it automatically, command <code>bsub &lt; EASYPAR_LSF_submission.sh</code> will submit the jobs to the cluster.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Giulio Caravagna.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
