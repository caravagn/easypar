<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LSF array jobs with easypar â€¢ easypar</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="LSF array jobs with easypar">
<meta property="og:description" content="">
<meta property="og:image" content="/logo.png">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">easypar</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.2.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/easypar.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/lsf.html">LSF array jobs with easypar</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/caravagn/easypar">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>LSF array jobs with easypar</h1>
                        <h4 class="author">Giulio Caravagna</h4>
            
            <h4 class="date">15 November 2018</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/caravagn/easypar/blob/master/vignettes/lsf.Rmd"><code>vignettes/lsf.Rmd</code></a></small>
      <div class="hidden name"><code>lsf.Rmd</code></div>

    </div>

    
    
<p><code>easypar</code> can be used to submit jobs to the LSF cluster system.</p>
<p>In particular, function <code>run_lsf</code> generates all the required inputs to submit an array of jobs of any size.</p>
<div id="requirements" class="section level4">
<h4 class="hasAnchor">
<a href="#requirements" class="anchor"></a>Requirements</h4>
<p>To use <code>run_lsf</code> you need:</p>
<ul>
<li><p>your computation to be wrapped into a function <code>FUN</code> that can run as a stand-alone R application (so something that would run if called via <code>Rscript</code>);</p></li>
<li><p>a input data.frame where every row rappresents an input for the function (as for <code>apply</code> by row).</p></li>
</ul>
<p>The input should have column names without dots or spaces, as these will be used to match the arguments of <code>FUN</code> with the same ordering of the function definition. So for instance an input with 2-columns will only work if the function is expecting 2 parameters. The fist column will define the first parameter.</p>
</div>
<div id="output" class="section level4">
<h4 class="hasAnchor">
<a href="#output" class="anchor"></a>Output</h4>
<p>This function generates 3 files:</p>
<ul>
<li><p>an R script wrapping the definition of your function <code>FUN</code>, as well as the required code to call that function using parameters from the command line. Your function in this script is called with a fake name;</p></li>
<li><p>a <code>tsv</code> file containing the input <code>PARAMS</code>, without any header (column names), and row names. function using parameters from the command line;</p></li>
<li><p>a LSF array job submission script with <code>N</code> jobs where <code>N</code> are the rows of <code>PARAMS</code>.</p></li>
</ul>
</div>
<div id="customisations-required" class="section level4">
<h4 class="hasAnchor">
<a href="#customisations-required" class="anchor"></a>Customisations (required)</h4>
<p>Some basic customisations are possibles, and some are <strong>required</strong>.</p>
<p>In particular, cluster-specific BSUB instructions have to be specified, as explained below, as well as other dependencies which depend on modules available on the cluster.</p>
<p>Function <code>run_lsf</code> allows to:</p>
<ul>
<li>specify a list of modules that will be added as dependencies of the LSF submission script.
<ul>
<li>For instance, <code>modules = 'R/3.4.0'</code> will generate the dependecy for a specific R version as <code>"module load R/3.4.0"</code> in the script.</li>
</ul>
</li>
<li>customize the BSUB parameters of the generated script.</li>
</ul>
<p>Default BSUB parameters parameters <strong>have to be updated according to your cluster setup</strong>.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(easypar)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="co"># Default parameters in the package</span></a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="kw"><a href="../reference/default_BSUB_config.html">default_BSUB_config</a></span>()</a></code></pre></div>
<pre><code>## $`-J`
## [1] "EASYPAR_Runner"
## 
## $`-P`
## [1] "dummy_project"
## 
## $`-q`
## [1] "dummy_queue"
## 
## $`-n`
## [1] 1
## 
## $`-R`
## [1] "\"span[hosts=1]\""
## 
## $`-W`
## [1] "168:00"
## 
## $`-o`
## [1] "EASYPAR_Runner.output.%J.%I"
## 
## $`-e`
## [1] "EASYPAR_Runner.errors.%J.%I"</code></pre>
<p>These are classical BSUB parameters:</p>
<ul>
<li>
<code>-J</code>, the job ID;</li>
<li>
<code>-P</code>, the project ID;</li>
<li>
<code>-q</code>, the queue ID;</li>
<li>
<code>-n</code> and <code>-R</code>, the resources to allocate;</li>
<li>
<code>-W</code> the wall time of the jobs;</li>
<li>
<code>-o</code> and <code>-e</code>, the outputs and the error filenames. Notice that by default we have the job array ID in the filename, so to have one log per job.</li>
</ul>
<blockquote>
<p>It is required to modify the default values of <code>-P</code> and <code>-q</code>, the project and queue ID, according to your LSF configuration. Otherwise, the submission script will generate an error becaue the default values do not mean anything.</p>
</blockquote>
<p>Modifications are done to the default list of parameters; other BSUB flags can be used as well. No checkings on their correctness are done by <code>easypar</code>.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1">custom_BSUB =<span class="st"> </span><span class="kw"><a href="../reference/default_BSUB_config.html">default_BSUB_config</a></span>()</a>
<a class="sourceLine" id="cb3-2" data-line-number="2"></a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="co"># More informative job ID</span></a>
<a class="sourceLine" id="cb3-4" data-line-number="4">custom_BSUB<span class="op">$</span><span class="st">`</span><span class="dt">-J</span><span class="st">`</span> =<span class="st"> "bwa_aligner"</span></a>
<a class="sourceLine" id="cb3-5" data-line-number="5"></a>
<a class="sourceLine" id="cb3-6" data-line-number="6"><span class="co"># A token for a project allowed to run on the cluster</span></a>
<a class="sourceLine" id="cb3-7" data-line-number="7">custom_BSUB<span class="op">$</span><span class="st">`</span><span class="dt">-P</span><span class="st">`</span> =<span class="st"> "DKSMWOP331"</span></a>
<a class="sourceLine" id="cb3-8" data-line-number="8"></a>
<a class="sourceLine" id="cb3-9" data-line-number="9"><span class="co"># A queue name that is valid on the cluster</span></a>
<a class="sourceLine" id="cb3-10" data-line-number="10">custom_BSUB<span class="op">$</span><span class="st">`</span><span class="dt">-q</span><span class="st">`</span> =<span class="st"> "bioinformatics"</span></a></code></pre></div>
<p>Once the BSUB has been customized, you can either:</p>
<ul>
<li>generate the submission scripts, and submit your job manually</li>
<li>generate the submission scripts and submit the jobs with a <code>system</code> call.</li>
</ul>
<p>By default (<code>run = FALSE</code>) the <code>run_lsf</code> function outputs the shell command that should be used to submit the jobs, but leaves the user to submit the job. This is because we experienced some command line issues calling modules with a system call.</p>
<p>An example computation follows.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="co"># A simple function that prints some outputs</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2">FUN =<span class="st"> </span><span class="cf">function</span>(x, y){ </a>
<a class="sourceLine" id="cb4-3" data-line-number="3">  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(x, y) </a>
<a class="sourceLine" id="cb4-4" data-line-number="4">}</a>
<a class="sourceLine" id="cb4-5" data-line-number="5"></a>
<a class="sourceLine" id="cb4-6" data-line-number="6"><span class="co"># input for 25 array jobs</span></a>
<a class="sourceLine" id="cb4-7" data-line-number="7">PARAMS =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(</a>
<a class="sourceLine" id="cb4-8" data-line-number="8">  <span class="dt">x =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Uniform">runif</a></span>(<span class="dv">25</span>), </a>
<a class="sourceLine" id="cb4-9" data-line-number="9">  <span class="dt">y =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Uniform">runif</a></span>(<span class="dv">25</span>)</a>
<a class="sourceLine" id="cb4-10" data-line-number="10">  )</a>
<a class="sourceLine" id="cb4-11" data-line-number="11"></a>
<a class="sourceLine" id="cb4-12" data-line-number="12"><span class="co"># generates the input files, adding some module dependencies</span></a>
<a class="sourceLine" id="cb4-13" data-line-number="13"><span class="kw"><a href="../reference/run_lsf.html">run_lsf</a></span>(FUN, PARAMS, </a>
<a class="sourceLine" id="cb4-14" data-line-number="14">        <span class="dt">BSUB_config =</span> custom_BSUB,</a>
<a class="sourceLine" id="cb4-15" data-line-number="15">        <span class="dt">modules =</span> <span class="st">'R/3.4.0'</span></a>
<a class="sourceLine" id="cb4-16" data-line-number="16">        )</a></code></pre></div>
<pre><code>## 
## =-=-=-=-=-=-=-=-=-=-=-=-
##  LSF submission script
## =-=-=-=-=-=-=-=-=-=-=-=-
## #!/bin/bash
## 
## #BSUB -J bwa_aligner[1-25]
## #BSUB -P DKSMWOP331
## #BSUB -q bioinformatics
## #BSUB -n 1
## #BSUB -R "span[hosts=1]"
## #BSUB -W 168:00
## #BSUB -o EASYPAR_Runner.output.%J.%I
## #BSUB -e EASYPAR_Runner.errors.%J.%I
## 
## # =-=-=-=-=-=-=-=-=-=-=-=-=-==-=-=-=-=-=-=-=-=
## # Automatic LSF script generated via easypar
## # 2019-09-26 01:10:22
## # =-=-=-=-=-=-=-=-=-=-=-=-=-==-=-=-=-=-=-=-=-=
## 
## # Required modules
## module load R/3.4.0 
## 
## 
## # Input file and R script
## file_input=EASYPAR_LSF_input_jobarray.csv
## R_script=EASYPAR_LSF_Run.R
## line=$LSB_JOBINDEX
## 
## # Data loading
## x=$( awk -v line=$line 'BEGIN {FS="\t"}; FNR==line {print $1}' $file_input)
## y=$( awk -v line=$line 'BEGIN {FS="\t"}; FNR==line {print $2}' $file_input)
## 
## # Job run
## Rscript $R_script $x $y
## =-=-=-=-=-=-=-=-=-=-
##  Input file (head)
## =-=-=-=-=-=-=-=-=-=-
## 
## =-=-=-=-=-=-=-=-=-
##  R script (head)
## =-=-=-=-=-=-=-=-=-</code></pre>
<pre><code>## 
## Scripts generated, submit your job with the following shell command.</code></pre>
<pre><code>## bsub &lt; EASYPAR_LSF_submission.sh</code></pre>
<p>Command <code>bsub &lt; EASYPAR_LSF_submission.sh</code> will submit the jobs to the cluster.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Giulio Caravagna.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
